<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="pragma" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <title>Interactive Map with Full Features</title>
    <link rel="stylesheet" href="./css/style.css" />
    <script
      src="https://kit.fontawesome.com/0980807b0f.js"
      crossorigin="anonymous"
    ></script>
    <link rel="stylesheet" href="./leaflet/leaflet.css" />
    <script src="./leaflet/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.rawgit.com/mapbox/wellknown/master/wellknown.js"></script>
    <script src="https://unpkg.com/leaflet.gridlayer.googlemutant@latest/dist/Leaflet.GoogleMutant.js"></script>

    <!-- 加載 Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script src="js/OSMBuildings-Leaflet.js"></script>
    <script src="./net/net.js"></script>
    <style>
      #map {
        height: 800px;
        width: 100%;
        top: 50px;
      }
      .floating-menu {
        position: absolute;
        top: 130px;
        left: 10px;
        background-color: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        z-index: 1000;
      }
      .search-menu{

      }
    </style>
  </head>
  <body>
    <nav>
      <input type="checkbox" id="check" name="" value="" />
      <label for="check" class="checkbtn">
        <i class="fas fa-bars"></i>
      </label>
      <label class="logo">WebGis</label>
      <ul>
<!--        <li><a href="index.html">地區資訊</a></li>-->
        <li><a href="diffpage.html">管線圖</a></li>
      </ul>
    </nav>
    <!-- 搜尋欄 -->
    <div class="search-menu">
      <select id="sectno-select">
        <!-- 動態加載的 `sectno` 選項會填充到這裡 -->
      </select>
      <button id="search-sectno-btn">搜尋</button>
    </div>


    <div class="floating-menu">
      <button id="clear-route-btn">清空路徑</button>
<!--      <button id="request-all-info">請求所有資訊</button>-->
      <button id="flag-of-reflash">及時刷新/查詢模式</button>
      <button id="mark-btn">標記</button>
    </div>

    <div class="info-panel" id="info-panel">
      <button id="toggle-button" class="toggle-btn">
        <i class="fas fa-chevron-left"></i>
        <!-- FontAwesome 按鈕圖示 -->
      </button>
      <h2>地點資訊</h2>
      <div id="info-content">
        <!-- 地點資訊將顯示在這裡 -->
        點擊地圖上的地點以顯示更多資訊
      </div>
    </div>

    <div id="map"></div>

    <!-- 清空路徑按鈕 -->

    <script>


      // 定義 initialize 函數
      function initialize() {
        console.log("Google Maps API 已成功加載並初始化");
        // 在這裡初始化地圖或其他 Google Maps 功能
        L.gridLayer.googleMutant({
          type: 'roadmap', // 'satellite', 'roadmap', 'terrain', 'hybrid'
          maxZoom: 21,
        }).addTo(map);

      }




      //標記
      let markingEnabled = false;


      document.getElementById('mark-btn').addEventListener('click',()=>{
        markingEnabled=!markingEnabled;
        if(markingEnabled){
          alert('添加標記')
        }else{
          alert('標記功能關閉')
        }
      })
      // 初始化地圖，設定中心點與縮放等級
      let map = L.map("map").setView([23.0053, 120.206323], 18);



      // 向後端請求 Google API 金鑰
      fetch('http://localhost:8080/api/get-google-api-key')
              .then(response => response.text())
              .then(apiKey => {


                // 創建 script 標籤以動態加載 Google Maps API
                const script = document.createElement('script');
                script.type = 'text/javascript';
                script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initialize&libraries=places&loading=async`;
                script.async = true;
                script.defer = true;
                document.body.appendChild(script);
              })
              .catch(error => console.error('Error loading Google Maps API:', error));






      let kmlLayerGroup = L.layerGroup().addTo(map); // 用於存放 KML 資料的圖層
      // 監聽地圖的移動和縮放事件
      map.on('moveend', function() {
        console.log("移動地圖觸發")
      loadVisibleKmlData();
      });

      map.on('click', (event) => {
  if (!markingEnabled) {
    console.log("不能移除");
    return; // 如果標記功能沒有啟用，直接返回
  }


  // 取得點擊位置
  const { lat, lng } = event.latlng;

  // 創建唯一的標識符，用於區分不同標記的按鈕
  const uniqueId = Date.now();

  let marker = L.marker([lat, lng]).addTo(map);

  // 創建自定義的彈窗容器
  let popupContent = document.createElement('div');
  popupContent.innerHTML = `
    <div>
      <label>時間: <input type="datetime-local" id="event-time-${uniqueId}" /></label><br/>
      <label>地點: <input type="text" id="event-location-${uniqueId}" /></label><br/>
      <label>經緯度: <input type="text" id="event-latlng-${uniqueId}" value="${lat}, ${lng}" readonly /></label><br/>
      <label>事件描述: <textarea id="event-description-${uniqueId}"></textarea></label><br/>
      <button id="confirm-event-${uniqueId}">確認</button>
      <button id="cancel-event-${uniqueId}">取消</button>
    </div>
  `;

  // 綁定彈出視窗
  marker.bindPopup(popupContent).openPopup();

  // 監聽彈出視窗打開事件，在每次彈出視窗打開時綁定按鈕事件

    console.log("彈窗打開");
    // 綁定 "確認" 按鈕的點擊事件
    document.getElementById(`confirm-event-${uniqueId}`).addEventListener('click', () => {
      console.log("點擊");
      let inputFormData = {
        time: document.getElementById(`event-time-${uniqueId}`).value,
        location: document.getElementById(`event-location-${uniqueId}`).value,
        latlng: document.getElementById(`event-latlng-${uniqueId}`).value,
        description: document.getElementById(`event-description-${uniqueId}`).value,
      };

      // 將事件信息包裝成 JSON 並印出在控制台
      console.log(JSON.stringify(inputFormData));
      
    // 調用 postKMLData 方法
    postKMLData('http://localhost:8080/api/kml-data/saveKmlForm', inputFormData)
      .then(data => {
        console.log('成功發送並接收回應:', data);
      })
      .catch(error => {
        console.error('Error in posting data:', error);
      });
        // // 關閉標記的彈出視窗
        // marker.closePopup();
      });

    // 綁定 "取消" 按鈕的點擊事件
    document.getElementById(`cancel-event-${uniqueId}`).addEventListener('click', () => {
      console.log("移除");
      // 移除標記
      map.removeLayer(marker);
    });

});



      // 添加 OSMBuildings
      // let osmb = new OSMBuildings(map).load(
      //   "https://{s}.data.osmbuildings.org/0.2/59fcc2e8/tile/{z}/{x}/{y}.json"
      // );

      // 定義一個 handler 函數來處理觸摸事件
      function handler(event) {
        // 這裡可以處理觸摸事件的邏輯，例如打開控制台輸出事件
      //  console.log("觸摸事件觸發: ", event.type);
      }
      document
        .getElementById("map")
        .addEventListener("touchstart", handler, { passive: true });
      document
        .getElementById("map")
        .addEventListener("touchmove", handler, { passive: true });

   
    
      // 清空路徑按鈕功能
      document
        .getElementById("clear-route-btn")
        .addEventListener("click", () => {
          map.eachLayer(function (layerOnMap) {
         //   console.log("layerOnMap=",layerOnMap)
          if (layerOnMap instanceof L.GeoJSON) {  // 檢查是否是 GeoJSON 圖層
            map.removeLayer(layerOnMap);  // 移除該圖層
        }
    });
        });

      // 添加事件監聽器到收縮/展開按鈕
      document
        .getElementById("toggle-button")
        .addEventListener("click", function () {
          const infoPanel = document.getElementById("info-panel");
          // 切換 'collapsed' 類，控制面板的展開與收縮
          infoPanel.classList.toggle("collapsed");
          infoPanel.style.padding = "40px";
        });

      // 將經緯度轉換為 Three.js 坐標
      function convertLatLngToPosition(lat, lng) {
        let point = map.latLngToLayerPoint([lat, lng]);
      //  console.log("Converted point:", point);
        return new THREE.Vector3(point.x, point.y, 0);
      }


// 根據地圖範圍加載 KML 資料
function loadVisibleKmlData() {
    // 獲取當前地圖的視圖範圍
    let bounds = map.getBounds();
    let minLng = bounds.getWest();
    let minLat = bounds.getSouth();
    let maxLng = bounds.getEast();
    let maxLat = bounds.getNorth();
    
    // 分頁參數
    let page = 0;
    let size = 1000;  // 每次加載 1000 筆資料，根據需要調整

    // 發送請求獲取當前視圖範圍內的 KML 資料
    getKMLData(`http://localhost:8080/api/kml-data/bounds?minLng=${minLng}&minLat=${minLat}&maxLng=${maxLng}&maxLat=${maxLat}&page=${page}&size=${size}`)
       
        .then(kmlDataList => {
            // 在地圖上繪製新的資料
            drawGeoJSONOnMap(kmlDataList);
        })
        .catch(error => {
            console.error('Error fetching KML data by bounds:', error);
        });
}

     function drawGeoJSONOnMap(kmlDataList){
       // 清空之前的 KML 圖層
    kmlLayerGroup.clearLayers();
      kmlDataList.forEach((kmlData) => {
      //  console.log("kmlData=",kmlData)
                // 解析 WKT 為 GeoJSON 格式
                let geometry = wellknown.parse(kmlData.geom);

                // 構造符合標準的 GeoJSON 結構，包括 type 和 properties
                let geojsonFeature = {
                  type: "Feature", // 定義 GeoJSON 的類型
                  properties: {
                    name: kmlData.name, // 手動附加屬性
                    sectno: kmlData.sectno,
                    parcelno: kmlData.parcelno
                  },
                  geometry: geometry // 解析後的 geometry
                };

                // 繪製多邊形到地圖上
                let layer = L.geoJSON(geojsonFeature, {
                  style: function (feature) {
                    // 根據 `sectno` 或其他屬性來設置不同顏色
                    let fillColor = "#fffc00"; // 默認顏色為黃色
                    if (
                      feature.properties &&
                      feature.properties.sectno === "0061"
                    ) {
                      fillColor = "#00ff00"; // 如果 sectno 為 "0061"，設置為綠色
                    } else if (
                      feature.properties &&
                      feature.properties.sectno === "0062"
                    ) {
                      fillColor = "#00ff00"; // 如果 sectno 為 "0062"，設置為綠色
                    }

                    return {
                      color: "#ff7800", // 邊界顏色
                      weight: 2, // 邊界線寬度
                      opacity: 1, // 邊界透明度
                      fillColor: fillColor, // 根據屬性動態設置填充顏色
                      fillOpacity: 0.3 // 填充透明度
                    };
                  },
                  onEachFeature: function (feature, layer) {
                    // 確認 `onEachFeature` 中可以讀取到 `feature.properties`
                    //  console.log("Feature Properties in onEachFeature:", feature.properties);

                    // 為每個多邊形添加點擊事件
                    layer.on("click", function (e) {
                      const popupContent = `
                   <strong>名稱:</strong> ${feature.properties.name} <br/>
                   <strong>段號:</strong> ${feature.properties.sectno} <br/>
                   <strong>地號:</strong> ${feature.properties.parcelno}
                `;
                      // 彈出資訊
                      layer.bindPopup(popupContent).openPopup();

                      // 將信息顯示在右側的資訊面板中
                      document.getElementById("info-content").innerHTML = `
                        <h3>${feature.properties.name}</h3>
                        <p><strong>段號:</strong> ${feature.properties.sectno}</p>
                        <p><strong>地號:</strong> ${feature.properties.parcelno}</p>
                    `;

                      getKMLData(
                        `http://localhost:8080/api/kml-data/sectno/${feature.properties.sectno}/parcelno/${feature.properties.parcelno}`
                      )
                        .then((data) => {
                          dealLandsData(data);
                        })
                        .catch((error) => {
                          // 在這裡處理錯誤
                          console.error(
                            "Error request api/kml-data/test",
                            error
                          );
                        });
                    });
                  }
                }).addTo(map);
              });
     }

      //
      // document
      //   .getElementById("request-all-info")
      //   .addEventListener("click", () => {
      //     // 調用封裝的函數來獲取 KML 數據
      //     getKMLData("http://localhost:8080/api/kml-data/all")
      //       .then((kmlDataList) => {
      //         // 使用提取的函數來繪製數據到地圖上
      //         drawGeoJSONOnMap(kmlDataList);
      //       })
      //       .catch((error) => {
      //         // 在這裡處理錯誤
      //         console.error("Error handling KML data:", error);
      //       });
      //   });

      function dealLandsData(landInfolist) {
          console.log("landInfolist=", landInfolist);
          let item = document.createElement("p");
          if(landInfolist.length === 0) {
            console.log("資料為空")
            item.innerHTML = `
            <p><strong>資料內容:</strong>後端查無資料</p>`
          }
          else{
            let landInfo = landInfolist[0]
              item.innerHTML = `
                <p><strong>城市:</strong>${landInfo.county}</p>
                <p><strong>所屬單位:</strong>${landInfo.managerName}</p>
                <p><strong>土地價格:</strong>${landInfo.landValue}</p>
                <p><strong>市價:</strong>${landInfo.marketValue}</p>
                <p><strong>段號名稱:</strong>${landInfo.town}</p>
                <p><strong>面積:</strong>${landInfo.area}</p>
              `;

          }
          let info = document.getElementById("info-content");
          info.appendChild(item);
      }

    // 當頁面加載完成後調用此函數來加載 sectno 的選項
    document.addEventListener("DOMContentLoaded", function () {
      loadSectnoOptions();
    });

        // 用來從 API 加載 `sectno` 選項並填充到多選單
    function loadSectnoOptions() {
      axios
        .get("http://localhost:8080/api/kml-data/allsectno")
        .then((response) => {
          // 從回應中獲取 sectno 資料
          const sectnoList = response.data.data;
          const select = document.getElementById("sectno-select");

          // 將每個 sectno 加入到多選單中
          sectnoList.forEach((sectno) => {
            const option = document.createElement("option");
            option.value = sectno;
            option.text = sectno;
            select.appendChild(option);
          });
        })
        .catch((error) => {
          console.error("Error fetching sectno options:", error);
        });
    }
// 清空地圖上的所有圖層
function clearMap() {
  map.eachLayer((layer) => {
    if (layer instanceof L.geoJSON) {
      map.removeLayer(layer); // 移除所有 GeoJSON 圖層
    }
  });
}

// 處理搜尋按鈕的點擊事件
    document
      .getElementById("search-sectno-btn")
      .addEventListener("click", function () {
        const select = document.getElementById("sectno-select");
        const selectedSectno = select.value;

        // 這裡你可以根據選中的 `sectno` 去調用 API 或做其他處理
        if (selectedSectno) {
          console.log("Selected sectno:", selectedSectno);
          // 在繪製之前清空地圖
          clearMap();
          // 例如，你可以通過 API 調用來獲取該 `sectno` 的相關數據
          // 請求 API，並將返回的結果顯示在地圖上
          axios
            .get(`http://localhost:8080/api/kml-data/sectno/${selectedSectno}`)
            .then((response) => {
              const kmlData = response.data.data;
              console.log("KML data for sectno:", kmlData);

               // 使用提取的函數來繪製地圖數據
               drawGeoJSONOnMap(kmlData);
            })
            .catch((error) => {
              console.error("Error fetching KML data:", error);
            });
        } else {
          alert("請選擇一個段號");
        }
      });

    </script>
  </body>
</html>
